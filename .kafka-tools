# To delete topics using your filter:
# list_kafka_topics | grep "your_filter_here" | delete_kafka_topics

# To delete all topics with no messages and no consumers:
# delete_empty_topics

# Ensure the Kafka broker address environment variable is set
ensure_broker_env() {
  if [ -z "${KAFKA_BROKER}" ]; then
    echo "Error: KAFKA_BROKER environment variable is not set. Set it to the address:port of your Kafka broker."
    return 1
  fi
}

ensure_topic_env() {
  if [ -z "${TOPIC}" ]; then
    echo "Error: TOPIC environment variable is not set. Set it to the name of the Kafka topic."
    return 1
  fi
}

ensure_consumer_env() {
  if [ -z "${CONSUMER_GROUP}" ]; then
    echo "Error: CONSUMER_GROUP environment variable is not set. Set it to the name of the Kafka consumer group."
    return 1
  fi
}

# Function to list Kafka topics
list_kafka_topics() {
  ensure_broker_env || return 1

  export KAFKA_HEAP_OPTS='-Xms512m -Xmx1g'
  echo 'security.protocol=SSL' > /tmp/broker.config
  kafka-topics --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --list
}

# Function to list Kafka consumers
list_kafka_consumers() {
  ensure_broker_env || return 1

  export KAFKA_HEAP_OPTS='-Xms512m -Xmx1g'
  echo 'security.protocol=SSL' > /tmp/broker.config
  kafka-consumer-groups --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --list
}

# Function to delete Kafka topics from stdin
delete_kafka_topics() {
  ensure_broker_env || return 1

  export KAFKA_HEAP_OPTS='-Xms512m -Xmx1g'
  echo 'security.protocol=SSL' > /tmp/broker.config

  # Delete topics from stdin
  while IFS= read -r topic; do
    if kafka-topics --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --delete --topic "${topic}"; then
      echo "${topic}"
    fi
  done
}

# Function to describe Kafka log directories
describe_kafka_topic_log() {
  ensure_broker_env || return 1
  ensure_topic_env || return 1
  local TOPIC=$1

  export KAFKA_HEAP_OPTS='-Xms512m -Xmx1g'
  echo 'security.protocol=SSL' > /tmp/broker.config
  kafka-log-dirs --describe --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --topic-list $TOPIC
}

# Function to describe Kafka consumers
describe_kafka_consumers() {
  ensure_broker_env || return 1
  ensure_consumer_env || return 1
  local CONSUMER_GROUP=$1

  export KAFKA_HEAP_OPTS='-Xms512m -Xmx1g'
  echo 'security.protocol=SSL' > /tmp/broker.config
  kafka-consumer-groups --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --describe --group $CONSUMER_GROUP
}

# Main function to identify topics with no messages and no consumers
find_empty_topics() {
  ensure_broker_env || return 1

  # Get all topics
  TOPICS=$(list_kafka_topics)

  # Convert the topics into an array
  TOPICS_ARRAY=()
  while IFS= read -r line; do
    TOPICS_ARRAY+=("$line")
  done <<< "$TOPICS"

  # Get all topics with no messages
  TOPICS_HAS_NO_MESSAGE=()

  for TOPIC in "${TOPICS_ARRAY[@]}"; do
    echo "Checking topic: $TOPIC"
    SIZE=$(describe_kafka_topic_log $TOPIC | awk 'NR > 1' | tail -n +2 | jq '[.brokers[].logDirs[].partitions[].size] | add')
    
    if [ "$SIZE" = "0" ]; then
      TOPICS_HAS_NO_MESSAGE+=("$TOPIC")
    fi
  done

  # Get all consumers topics
  CONSUMERS=$(list_kafka_consumers)

  # Convert the consumers into an array
  CONSUMERS_ARRAY=()
  while IFS= read -r line; do
    CONSUMERS_ARRAY+=("$line")
  done <<< "$CONSUMERS"

  # Get all topics in consumers
  TOPICS_IN_CONSUMERS=()

  for CONSUMER_GROUP in "${CONSUMERS_ARRAY[@]}"; do
    echo "Checking consumer group: $CONSUMER_GROUP"
    CONSUMER_TOPICS=$(describe_kafka_consumers $CONSUMER_GROUP | awk 'NR > 1' | tail -n +2 | awk '{print $2}')
    TOPICS_IN_CONSUMERS+=("$CONSUMER_TOPICS")
  done

  # Get all topics with no consumers
  TOPICS_HAS_NO_CONSUMER=()

  for TOPIC in "${TOPICS_HAS_NO_MESSAGE[@]}"; do
    if [[ ! " ${TOPICS_IN_CONSUMERS[@]} " =~ " ${TOPIC} " ]]; then
      TOPICS_HAS_NO_CONSUMER+=("$TOPIC")
    fi
  done

  # Remove topics that starts with "_confluent"
  TOPICS_HAS_NO_CONSUMER=("${TOPICS_HAS_NO_CONSUMER[@]/_confluent*/}")

  echo -e "\n\nTopics with no messages and no consumers: \n${TOPICS_HAS_NO_CONSUMER[@]}"
}

delete_empty_topics() {
  ensure_broker_env || return 1

  find_empty_topics
  read -p "Do you want to delete these topics? (y/N): " confirm
  case $confirm in
    [yY])
      echo ${TOPICS_HAS_NO_CONSUMER[@]} | delete_kafka_topics
      ;;
    *)
      echo "No topics were deleted."
      ;;
  esac
}

audit_segment_configs() {
  ensure_broker_env || return 1

  echo "Auditando t√≥picos com configura√ß√µes de segment e fator de replica√ß√£o..."
  
  export KAFKA_HEAP_OPTS='-Xms512m -Xmx1g'
  echo 'security.protocol=SSL' > /tmp/broker.config
  
  # Obt√©m lista de t√≥picos, filtrando t√≥picos internos
  topics=$(kafka-topics --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --list | grep -v '^__' | grep -v '^_confluent' | grep -v '^_schemas')
  
  problematic_topics=""
  replication_issues=""
  
  echo "======================================="
  echo "VERIFICA√á√ÉO DE FATOR DE REPLICA√á√ÉO (AWS MSK)"
  echo "======================================="
  
  # Verifica fator de replica√ß√£o conforme recomenda√ß√£o da AWS
  replication_check=$(kafka-topics --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --describe | grep ReplicationFactor)
  
  echo "Verificando t√≥picos com ReplicationFactor = 1..."
  echo
  
  rf1_topics=$(echo "$replication_check" | grep 'ReplicationFactor:1' | awk '{print $2}' | sed 's/Topic://')
  
  if [ -n "$rf1_topics" ]; then
    echo "‚ö†Ô∏è  ALERTA DE SEGURAN√áA - AWS MSK:"
    echo "Os seguintes t√≥picos t√™m ReplicationFactor = 1:"
    echo "$rf1_topics"
    echo
    echo "RISCO: Falhas de escrita/leitura durante:"
    echo "- Problemas transit√≥rios"
    echo "- Atualiza√ß√µes de software"  
    echo "- Falhas de hardware"
    echo
    echo "A√á√ÉO REQUERIDA PELA AWS:"
    echo "- Configurar ReplicationFactor = 3"
    echo "- Configurar MinISR (min.insync.replicas) = 2"
    echo
    replication_issues="$rf1_topics"
  else
    echo "‚úÖ Todos os t√≥picos t√™m ReplicationFactor >= 2"
  fi
  
  echo "======================================="
  echo "VERIFICA√á√ÉO DE CONFIGURA√á√ïES DE SEGMENT"
  echo "======================================="
  
  for topic in $topics; do
    echo "=== Verificando t√≥pico: $topic ==="
    configs=$(kafka-configs --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --entity-type topics --entity-name $topic --describe | grep -E '(segment\.bytes|segment\.ms)')
    
    is_problematic=false
    
    if [ -n "$configs" ]; then
      echo "$configs"
      
      # Verifica segment.bytes < 125MB (131072000 bytes)
      segment_bytes=$(echo "$configs" | grep 'segment.bytes' | sed 's/.*segment.bytes=\([0-9]*\).*/\1/')
      if [ -n "$segment_bytes" ] && [ "$segment_bytes" -lt 131072000 ]; then
        is_problematic=true
      fi
      
      # Verifica segment.ms < 1 dia (86400000 ms)
      segment_ms=$(echo "$configs" | grep 'segment.ms' | sed 's/.*segment.ms=\([0-9]*\).*/\1/')
      if [ -n "$segment_ms" ] && [ "$segment_ms" -lt 86400000 ]; then
        is_problematic=true
      fi
      
      if [ "$is_problematic" = true ]; then
        problematic_topics="$problematic_topics$topic: $configs\n"
      fi
    else
      echo "Usando configura√ß√µes padr√£o (segment.bytes=1GB, segment.ms=1 semana) - OK"
    fi
    echo
  done
  
  echo "======================================="
  echo "RESUMO GERAL - PROBLEMAS ENCONTRADOS"
  echo "======================================="
  
  # Resumo de problemas de replica√ß√£o (prioridade alta - AWS)
  if [ -n "$replication_issues" ]; then
    echo "üö® CR√çTICO - FATOR DE REPLICA√á√ÉO (A√á√ÉO IMEDIATA REQUERIDA):"
    echo "T√≥picos com ReplicationFactor = 1:"
    echo "$replication_issues"
    echo
    echo "COMANDOS PARA VERIFICA√á√ÉO ADICIONAL:"
    echo "# Para verificar configura√ß√£o MinISR:"
    echo "kafka-configs --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --entity-type topics --entity-name <TOPIC_NAME> --describe | grep min.insync.replicas"
    echo
    echo "# Para alterar configura√ß√µes (exemplo):"
    echo "# NOTA: ReplicationFactor n√£o pode ser alterado ap√≥s cria√ß√£o do t√≥pico"
    echo "# Ser√° necess√°rio recriar os t√≥picos ou usar ferramentas de migra√ß√£o"
    echo "kafka-configs --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --entity-type topics --entity-name <TOPIC_NAME> --alter --add-config min.insync.replicas=2"
    echo
  fi
  
  # Resumo de problemas de segment
  if [ -n "$problematic_topics" ]; then
    echo "‚ö†Ô∏è  CONFIGURA√á√ïES DE SEGMENT PROBLEM√ÅTICAS:"
    echo "Os seguintes t√≥picos t√™m configura√ß√µes abaixo do recomendado:"
    echo "(segment.bytes < 125MB ou segment.ms < 1 dia)"
    echo
    printf "$problematic_topics"
    echo
    echo "A√á√ÉO RECOMENDADA: Ajustar as configura√ß√µes destes t√≥picos."
    echo "Recomendado: segment.bytes >= 125MB (131072000) e segment.ms >= 1 dia (86400000)"
    echo
  fi
  
  # Status final
  if [ -z "$replication_issues" ] && [ -z "$problematic_topics" ]; then
    echo "‚úÖ TUDO OK!"
    echo "‚úÖ Todos os t√≥picos t√™m ReplicationFactor adequado"
    echo "‚úÖ Todas as configura√ß√µes de segment est√£o seguras"
  fi
}

list_compact_only_topics() {
  ensure_broker_env || return 1

  echo "Listando t√≥picos internos que usam apenas 'compact'..."
  
  export KAFKA_HEAP_OPTS='-Xms512m -Xmx1g'
  echo 'security.protocol=SSL' > /tmp/broker.config
  
  # Listar t√≥picos internos
  internal_topics=$(kafka-topics --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --list | grep -E '(changelog|repartition|_confluent)')
  
  if [ -z "$internal_topics" ]; then
    echo "Nenhum t√≥pico interno encontrado."
    return 0
  fi
  
  echo "T√≥picos encontrados:"
  echo "$internal_topics"
  echo
  
  echo "Aplicando compact,delete para cada t√≥pico..."
  echo
  
  # Aplicar compact,delete para cada t√≥pico
  for topic in $internal_topics; do
    echo "Updating $topic..."
    
    if kafka-configs --bootstrap-server ${KAFKA_BROKER} --command-config=/tmp/broker.config --entity-type topics --entity-name "$topic" --alter --add-config cleanup.policy=compact,delete; then
      echo "‚úÖ $topic atualizado com sucesso"
    else
      echo "‚ùå Erro ao atualizar $topic"
    fi
    
    echo
  done
  
  echo "Script conclu√≠do!"
}
